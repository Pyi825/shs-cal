<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS System (Print Fixed)</title>
    
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22SHS%20POS%22,%22short_name%22:%22SHS%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22%23ffffff%22,%22theme_color%22:%22%232c3e50%22,%22icons%22:[{%22src%22:%22https://cdn-icons-png.flaticon.com/512/566/566445.png%22,%22sizes%22:%22512x512%22,%22type%22:%22image/png%22}]}">
    <meta name="theme-color" content="#2c3e50">
    <meta name="mobile-web-app-capable" content="yes">

    <style>
        /* UI Styles consistent with v41 */
        body { font-family: 'Myanmar3', -apple-system, BlinkMacSystemFont, sans-serif; margin: 20px; background-color: #f4f4f9; color: #333; }
        .container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #2c3e50; margin-bottom: 20px;}
        label { display: block; margin-top: 15px; font-weight: bold; font-size: 0.9em; }
        input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px; font-size: 12px; box-sizing: border-box;}
        .rate-section { background-color: #fff9e6; padding: 15px; border-radius: 8px; border-left: 5px solid #ff9900; margin-bottom: 20px; }
        #results { margin-top: 25px; padding: 20px; background-color: #ebf5fb; border-radius: 8px; border: 1px solid #3498db; }
        
        .btn { width: 100%; padding: 15px; margin-top: 10px; border: none; border-radius: 8px; font-size: 17px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-next { background-color: #27ae60; color: white; }
        .btn-wa { background-color: #25D366; color: white; border-bottom: 3px solid #128C7E; }
        .btn-print { background-color: #3498db; color: white; }
        .btn-print:disabled { background-color: #bdc3c7; cursor: not-allowed; opacity: 0.6; }
        .btn-reprint-action { background-color: #8e44ad; color: white; }
        .btn-clear { background-color: #e74c3c; color: white; font-size: 13px; margin-top: 20px; }
        #submit-msg { margin-top: 12px; font-weight: bold; text-align: center; color: #e67e22; font-size: 0.9em; }
        .hidden { display: none !important; }

        /* --- RECEIPT DESIGN --- */
        #receipt-content { 
            font-family: 'Myanmar3', -apple-system, BlinkMacSystemFont, sans-serif; 
            color: #000; 
            padding: 5px; 
            width: 100%;
            box-sizing: border-box;
            background: white;
            line-height: 1.2;
        }
        .receipt-header { text-align: center; margin-bottom: 12px; border-bottom: 1px dashed #000; padding-bottom: 8px; }
        .receipt-header h3 { margin: 0; font-size: 15px; letter-spacing: 1px; }
        
        .receipt-row { display: flex; justify-content: space-between; margin: 3px 0; align-items: baseline; }
        .receipt-label { font-size: 12px; flex: 1; text-transform: uppercase; }
        
        .receipt-value { 
            font-weight: bold; 
            font-size: 10px; 
            text-align: right; 
            flex: 1.1; 
            word-break: break-all;
            font-family: 'Myanmar3', -apple-system, BlinkMacSystemFont, sans-serif; 
        }
        
        .receipt-total-section { text-align: center; margin-top: 12px; padding: 10px 0; border-top: 1px dashed #000; border-bottom: 1px dashed #000; }
        .receipt-total-label { font-size: 12px; display: block; font-weight: bold; }
        .receipt-total-value { font-size: 12px; font-weight: bold; display: block; margin-top: 2px; }
        .dashed-hr { border: none; border-top: 1px dashed #000; margin: 8px 0; width: 100%; }

        /* History */
        .history-section { margin-top: 30px; border-top: 2px solid #eee; padding-top: 10px; }
        .history-table { width: 100%; font-size: 0.85em; border-collapse: collapse; margin-top: 10px; }
        .history-table th, .history-table td { text-align: left; padding: 10px 5px; border-bottom: 1px solid #eee; }
        .btn-reprint { background-color: #f39c12; color: white; padding: 5px 8px; font-size: 11px; border-radius: 4px; border:none; cursor: pointer;}

        /* --- ANDROID & MOBILE PRINT FIX --- */
        @media print {
            @page { size: auto; margin: 0mm; }
            body { background: #fff; margin: 0; padding: 0; -webkit-print-color-adjust: exact; }
            .container > div:not(#step-3), .no-print, .btn, h2, .history-section { display: none !important; }
            #step-3, #receipt-content { display: block !important; visibility: visible !important; position: absolute; top: 0; left: 0; width: 80mm ; margin: 0 !important; padding: 4mm 5mm !important; }
            #receipt-content * { color: #000 !important; visibility: visible !important; background: transparent !important; }
            .receipt-value, .receipt-label { font-size: 13.5px !important; }
            .receipt-total-value { font-size: 13.5px !important; }
        }
    </style>
</head>
<body>

<div class="container">
    <div id="step-1">
        <h2>💰 SHS Calculator</h2>
        <div class="rate-section">
            <div style="display: flex; gap: 10px;">
                <div><label>ငွေစျေး</label><input type="number" id="rate-mmk" value="960" oninput="refreshAll()"></div>
                <div><label>ထိုင်းငွေစျေး</label><input type="number" id="rate-thb" value="7.2" oninput="refreshAll()"></div>
            </div>
        </div>
        <div style="display: flex; gap: 10px;">
            <select id="send-cur" onchange="refreshAll()"><option value="MYR">မလေးငွေ(ရင်းဂစ်)</option><option value="MMK">မြန်မာငွေ(ကျပ်)</option></select>
            <select id="recv-cur" onchange="autoUpdateType()"><option value="MMK">မြန်မာငွေ(ကျပ်)</option><option value="MYR">မလေးငွေ(ရင်းဂစ်)</option><option value="THB">ထိုင်းငွေ(ဘတ်)</option></select>
        </div>
        <label>ဘဏ်အမျိုးအစား</label>
        <select id="recv-type" onchange="onTypeChange()">
            <option value="Pay">ကေပေး</option>
            <option value="Pay">ဝေ့အကောင့်</option>
            <option value="Cash">ဝေ့ပစဝပ်</option>
            <option value="Bank">မြန်မာဘဏ်</option>
            <option value="Malay Bank">မလေးဘဏ်</option>
            <option value="Thai Bank">ထိုင်းဘဏ်</option>
        </select>
        <label>ပေးပို့ငွေ (<span id="unit-send">ရင်းဂစ်</span>)</label>
        <input type="text" id="send-amt" oninput="handleInput(this, 'send')" placeholder="0">
        <label>လက်ခံရမည့်ငွေ (<span id="unit-recv">ကျပ်</span>)</label>
        <input type="text" id="recv-amt" oninput="handleInput(this, 'receive')" placeholder="0">
        <div id="results">
            <p>လွဲခ: <span id="fee-res">0.00</span> <span id="fee-unit">ရင်းဂစ်</span></p>
            <p><strong>လက်ခံရမည့်ငွေ: <span id="total-res">0</span> <span id="total-unit">ကျပ်</span></strong></p>
        </div>
        <button class="btn btn-next" onclick="goToStep(2)">အချက်လက်ဖြည့်ရန်နှိပ်ပါ</button>

        <div class="history-section">
            <h3>📋 Recent History</h3>
            <table class="history-table">
                <thead><tr><th>Invoice</th><th>Receive</th><th>Action</th></tr></thead>
                <tbody id="history-body"></tbody>
            </table>
            <button class="btn btn-clear" onclick="clearHistory()">Clear History</button>
        </div>
    </div>

    <div id="step-2" class="hidden">
        <h2>📝 အချက်အလက်အားလုံးဖြည့်ပါ</h2>
        <label>ဆိုင်ခွဲ</label>
        <select id="branch-select">
            <option value="ရွှေနှင်းဆီ-၁၄မိုင်" data-phone="+60 12-345 6789">ရွှေနှင်းဆီ-၁၄မိုင်</option>
            <option value="ရွှေနှင်းဆီ-၁၂မိုင်" data-phone="+60 11-987 6543">ရွှေနှင်းဆီ-၁၂မိုင်</option>
        </select>
        <label>ငွေပေးချေမှု</label>
        <select id="pay-select"><option value="Cash">ငွေသားပေး</option><option value="Bank Transfer">ဘဏ်ထည့်</option></select>
        <label>ပေးပို့သူအမည်</label><input type="text" id="s-name" placeholder="Enter Sender Name/Phone No">
        <label>လက်ခံသူနာမည်</label><input type="text" id="r-name" placeholder="Enter Receiver Name">
        <label>အကောင့်နံပါတ်</label><input type="text" id="r-acc" placeholder="Enter Account/Phone No.">
        <button class="btn btn-next" onclick="validateGo(3)">စလစ်ထုတ်ရန်နှိပ်ပါ</button>
        <button class="btn" style="background:#95a5a6; color:white;" onclick="goToStep(1)">BACK</button>
    </div>

    <div id="step-3" class="hidden">
        <div id="receipt-content">
            <div class="receipt-header">
                <h3>ရွှေနှင်းဆီ စတိုးနှင့်စားသောက်ဆိုင်</h3>
                <h3>မလေး↔မြန်မာ ကုန်စည်ပို့ဆောင်ရေး</h3>
                <span id="res-branch" style="font-weight:bold; font-size: 12px; line-height: 1.5;"></span><br>
                <span id="res-phone" style="font-weight: bold; font-size: 12px;"></span><br>
                <span id="res-date" style="font-size: 11px;"></span>
            </div>
            <div class="receipt-row"><span class="receipt-label">ဘောင်ချာနံပါတ်:</span><span class="receipt-value" id="res-inv"></span></div>
            <div class="dashed-hr"></div>
            <div class="receipt-row"><span class="receipt-label">ပေးပို့သူအမည်:</span><span class="receipt-value" id="disp-sender"></span></div>
            <div class="receipt-row"><span class="receipt-label">ဘဏ်အမျိုးအစား:</span><span class="receipt-value" id="res-type"></span></div>
            <div class="receipt-row"><span class="receipt-label">လက်ခံသူနာမည်:</span><span class="receipt-value" id="res-rname"></span></div>
            <div class="receipt-row"><span class="receipt-label">အကောင့်နံပါတ်:</span><span class="receipt-value" id="res-racc"></span></div>
            <div class="dashed-hr"></div>
            <div class="receipt-row"><span class="receipt-label">ပေးပို့ငွေ:</span><span class="receipt-value" id="res-samt"></span></div>
            <div class="receipt-total-section">
                <span class="receipt-total-label">--- လက်ခံရမည့်ငွေ ---</span>
                <span class="receipt-total-value" id="res-ramt"></span>
            </div>
            <center><p style="font-size: 0.7em; margin-top: 10px; font-weight: bold;">*လက်ခံဖြတ်ပိုင်းအား ၁လအတွင်းသာတာဝန်ယူပါသည်</p></center>
        </div>
        <button class="btn btn-wa no-print" id="wa-btn" onclick="shareWA()">1. SHARE TO WHATSAPP</button>
        <button class="btn btn-print no-print" id="main-submit-btn" onclick="printAndSubmit()" disabled>2. PRINT & SUBMIT</button>
        <button class="btn btn-reprint-action no-print hidden" id="reprint-only-btn" onclick="window.print()">PRINT AGAIN</button>
        <div id="submit-msg" class="no-print">⚠️ WhatsApp share required to unlock print.</div>
        <button class="btn no-print" style="background:#e67e22; color:white;" onclick="resetForm()">NEW TRANSACTION</button>
    </div>
</div>
<script>
    const SCRIPT_URL = "URL Link";
    const SUCCESS_SOUND = new Audio('https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3');
    let history = JSON.parse(localStorage.getItem('pos_history_v42') || "[]");
    let lastSource = 'send';

    function getUnit(cur) {
        if(cur === 'MYR') return 'ရင်းဂစ်';
        if(cur === 'MMK') return 'ကျပ်';
        if(cur === 'THB') return 'ဘတ်';
        return cur;
    }

    function refreshAll() {
        const sCur = document.getElementById('send-cur').value;
        const rCur = document.getElementById('recv-cur').value;
        document.getElementById('unit-send').innerText = getUnit(sCur);
        document.getElementById('unit-recv').innerText = getUnit(rCur);
        document.getElementById('fee-unit').innerText = getUnit(sCur);
        document.getElementById('total-unit').innerText = getUnit(rCur);
        calculate(lastSource);
    }

    function calculate(source = null) {
        const rateMYRtoMMK = parseFloat(document.getElementById('rate-mmk').value) || 0;
        const rateMYRtoTHB = parseFloat(document.getElementById('rate-thb').value) || 0;
        const sendCurrency = document.getElementById('send-cur').value;
        const receiveCurrency = document.getElementById('recv-cur').value;
        const receiverType = document.getElementById('recv-type').value;
        
        let sendAmount = parseFloat(clean(document.getElementById('send-amt').value)) || 0;
        let receiveAmount = parseFloat(clean(document.getElementById('recv-amt').value)) || 0;

        let exchangeRate = 0;
        let feeBaseCurrency = null;
        let exchangeValid = true;

        if (sendCurrency === 'MYR' && receiveCurrency === 'MYR') {
            exchangeRate = 1;
            feeBaseCurrency = 'MYR'; 
        } else if (sendCurrency === 'MYR' && receiveCurrency === 'MMK') {
            exchangeRate = rateMYRtoMMK;
            feeBaseCurrency = 'MMK';
        } else if (sendCurrency === 'MMK' && receiveCurrency === 'MYR') {
            exchangeRate = 1 / rateMYRtoMMK;
            feeBaseCurrency = 'MMK';
        } else if (sendCurrency === 'MYR' && receiveCurrency === 'THB') {
            exchangeRate = rateMYRtoTHB;
            feeBaseCurrency = 'MYR';
        } else if (sendCurrency === 'THB' && receiveCurrency === 'MYR') {
            exchangeRate = 1 / rateMYRtoTHB;
            feeBaseCurrency = null;
        } else if (sendCurrency === receiveCurrency) {
            exchangeValid = false;
        } else {
            exchangeValid = false;
        }

        if (!exchangeValid || (source === null && sendAmount === 0 && receiveAmount === 0)) {
            return;
        }
        
        let calculatedFeeMYR = 0;
        let finalReceiveAmount = 0;
        let finalSendAmount = 0;

        if (source === 'send') {
            finalSendAmount = sendAmount;
            if (feeBaseCurrency === 'MMK') {
                const grossReceivedMMK = finalSendAmount * exchangeRate;
                calculatedFeeMYR = calculateFee(grossReceivedMMK, receiverType, 'MMK');
                finalReceiveAmount = (finalSendAmount - calculatedFeeMYR) * exchangeRate;
            } else if (feeBaseCurrency === 'MYR') {
                calculatedFeeMYR = calculateFee(finalSendAmount, receiverType, 'MYR');
                finalReceiveAmount = (finalSendAmount - calculatedFeeMYR) * exchangeRate;
            } else {
                calculatedFeeMYR = 0;
                finalReceiveAmount = finalSendAmount * exchangeRate;
            }
            
            if (receiveCurrency === 'MMK') {
                finalReceiveAmount = Math.round(finalReceiveAmount / 100) * 100;
            } else if (receiveCurrency === 'THB') {
                finalReceiveAmount = Math.round(finalReceiveAmount / 10) * 10;
            } else if (receiveCurrency === 'MYR') {
                finalReceiveAmount = Math.round(finalReceiveAmount);
            }
            
            document.getElementById('recv-amt').value = format(finalReceiveAmount);
        } else if (source === 'receive') {
            finalReceiveAmount = receiveAmount;
            if (feeBaseCurrency === 'MMK') {
                calculatedFeeMYR = calculateFee(finalReceiveAmount, receiverType, 'MMK');
                finalSendAmount = (finalReceiveAmount / exchangeRate) + calculatedFeeMYR;
            } else if (feeBaseCurrency === 'MYR') {
                let grossNeeded = finalReceiveAmount / exchangeRate;
                calculatedFeeMYR = calculateFee(grossNeeded + 10, receiverType, 'MYR'); 
                finalSendAmount = grossNeeded + calculatedFeeMYR;
            } else {
                calculatedFeeMYR = 0;
                finalSendAmount = finalReceiveAmount / exchangeRate;
            }
            
            finalSendAmount = Math.round(finalSendAmount);
            document.getElementById('send-amt').value = format(finalSendAmount);
        }

        document.getElementById('fee-res').innerText = calculatedFeeMYR.toFixed(2);
        document.getElementById('total-res').innerText = format(finalReceiveAmount);
    }

    function playDing() { SUCCESS_SOUND.play().catch(() => {}); }
    function format(n) { 
        if (!n) return "0";
        let num = n.toString().replace(/,/g, '');
        return Number(num).toLocaleString('en-US'); 
    }
    function clean(s) { return s.toString().replace(/,/g, ''); }
    function handleInput(el, src) { 
        let v = clean(el.value); 
        if (isNaN(v) || v === "") { el.value = ""; lastSource = src; calculate(src); return; } 
        el.value = format(v); 
        lastSource = src; 
        calculate(src); 
    }
    function onTypeChange() { if(document.getElementById('recv-type').value === 'Cash') document.getElementById('r-name').value = "ဝေ့ပစဝပ်"; refreshAll(); }

    function calculateFee(amount, type, currency) {
        let feeMYR = 0;
        const AMOUNT = parseFloat(amount);
        if (currency === 'MYR') {
            if (AMOUNT < 1) feeMYR = 0;
            else if (AMOUNT >= 1 && AMOUNT <= 200) feeMYR = 5;
            else if (AMOUNT >= 201 && AMOUNT <= 1000) feeMYR = 10;
            else if (AMOUNT >= 1001 && AMOUNT <= 2000) feeMYR = 20;
            else if (AMOUNT >= 2001) {
                if (AMOUNT <= 3000) feeMYR = Math.ceil(AMOUNT / 1000) * 10;
                else feeMYR = 30;
            }
            return Math.min(feeMYR, 30);
        }
        if (currency === 'MMK') {
            if (type === 'Pay' || type === 'Bank') {
                if (AMOUNT >= 1 && AMOUNT <= 100000) feeMYR = (type === 'Pay') ? 5 : 6;
                else if (AMOUNT > 100000 && AMOUNT <= 200000) feeMYR = (type === 'Pay') ? 6 : 7;
                else if (AMOUNT > 200000) feeMYR = ((type === 'Pay') ? 5 : 6) + Math.ceil((AMOUNT - 100000) / 100000);
                if (AMOUNT >= 3000000 && AMOUNT <= 10000000) feeMYR = Math.min(feeMYR, 30);
                else if (AMOUNT > 10000000 && AMOUNT <= 20000000) feeMYR = Math.min(feeMYR, 50);
                else if (AMOUNT > 20000000 && AMOUNT <= 30000000) feeMYR = Math.min(feeMYR, 100);
            } else if (type === 'Cash') {
                if (AMOUNT >= 1 && AMOUNT <= 100000) feeMYR = 8;
                else if (AMOUNT > 100000 && AMOUNT <= 200000) feeMYR = 11;
                else if (AMOUNT > 200000) feeMYR = 8 + (Math.ceil((AMOUNT - 100000) / 100000) * 3);
                feeMYR = Math.min(feeMYR, 70);
            }
        }
        return feeMYR;
    }
    
    function populateReceipt() {
        const sCur = document.getElementById('send-cur').value;
        const rCur = document.getElementById('recv-cur').value;
        const b = document.getElementById('branch-select'); 
        document.getElementById('res-inv').innerText = generateInvoiceNumber();
        document.getElementById('res-date').innerText = new Date().toLocaleString();
        document.getElementById('res-branch').innerText = b.value;
        document.getElementById('res-phone').innerText = "Tel: " + b.options[b.selectedIndex].getAttribute('data-phone');
        document.getElementById('res-type').innerText = document.getElementById('recv-type').options[document.getElementById('recv-type').selectedIndex].text;
        document.getElementById('disp-sender').innerText = document.getElementById('s-name').value;
        document.getElementById('res-rname').innerText = document.getElementById('r-name').value;
        document.getElementById('res-racc').innerText = document.getElementById('r-acc').value;
        const payMethod = document.getElementById('pay-select').value;
        document.getElementById('res-samt').innerText = document.getElementById('send-amt').value + " " + getUnit(sCur) + " (" + payMethod + ")";
        document.getElementById('res-ramt').innerText = document.getElementById('recv-amt').value + " " + getUnit(rCur);
        document.getElementById('main-submit-btn').disabled = true;
    }

    function shareWA() {
        const text = `ဆိုင်ခွဲ - ${document.getElementById('res-branch').innerText}\nဘောင်ချာနံပါတ်: ${document.getElementById('res-inv').innerText}\nပေးပို့သူ: ${document.getElementById('disp-sender').innerText}\nဘဏ်အမျိုးအစား: ${document.getElementById('res-type').innerText}\nလက်ခံသူနာမည်: ${document.getElementById('res-rname').innerText}\nအကောင့်နံပါတ်: ${document.getElementById('res-racc').innerText}\nပေးပို့ငွေ: ${document.getElementById('res-samt').innerText}\nလက်ခံရမည့်ငွေ: ${document.getElementById('res-ramt').innerText}`;
        window.open(`https://wa.me/?text=${encodeURIComponent(text)}`);
        document.getElementById('main-submit-btn').disabled = false;
        document.getElementById('submit-msg').innerText = "✅ WhatsApp Shared! Print Unlocked.";
        document.getElementById('submit-msg').style.color = "#27ae60";
    }

    function printAndSubmit() {
        const msgBox = document.getElementById('submit-msg');
        const now = new Date();
        const formattedDate = now.toLocaleDateString();
        const formattedTime = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const sAmt = clean(document.getElementById('send-amt').value);
        const rAmt = clean(document.getElementById('recv-amt').value);
        const sCur = document.getElementById('send-cur').value;
        const rCur = document.getElementById('recv-cur').value;
        const dataObj = {
            date: formattedDate,
            time: formattedTime,
            invoiceNo: document.getElementById('res-inv').innerText,
            branch: document.getElementById('res-branch').innerText,
            sender: document.getElementById('disp-sender').innerText,
            resType: document.getElementById('res-type').innerText,
            paySelect: document.getElementById('pay-select').value,
            receiverName: document.getElementById('res-rname').innerText,
            receiverAcc: document.getElementById('res-racc').innerText,
            resSamt: document.getElementById('res-samt').innerText,
            ramt: document.getElementById('res-ramt').innerText
        };

        const formData = new FormData();
        for (let key in dataObj) { formData.append(key, dataObj[key]); }
        let amtMYR=0, amtMMK=0, amtTHB=0;
        if(sCur==='MYR') amtMYR=sAmt; else if(sCur==='MMK') amtMMK=sAmt;
        if(rCur==='MYR') amtMYR=rAmt; else if(rCur==='MMK') amtMMK=rAmt; else if(rCur==='THB') amtTHB=rAmt;
        formData.append("amtMYR", amtMYR); formData.append("amtMMK", amtMMK); formData.append("amtTHB", amtTHB);
        formData.append("receiverAcc", dataObj.receiverAcc);

        msgBox.innerText = "Submitting Data...";
        if(SCRIPT_URL === "URL Link") {
            playDing();
            msgBox.innerText = "✅ Success! Printing...";
            history.unshift(dataObj);
            localStorage.setItem('pos_history_v42', JSON.stringify(history.slice(0,30)));
            setTimeout(() => { window.print(); setTimeout(resetForm, 1000); }, 200);
        } else {
            fetch(SCRIPT_URL, { method: "POST", body: formData })
            .then(() => {
                playDing();
                msgBox.innerText = "✅ Success! Printing...";
                history.unshift(dataObj);
                localStorage.setItem('pos_history_v42', JSON.stringify(history.slice(0,30)));
                setTimeout(() => { window.print(); setTimeout(resetForm, 1000); }, 200);
            });
        }
    }

    function getTodayKey() { const d = new Date(); return `${d.getFullYear()}${(d.getMonth()+1).toString().padStart(2,'0')}${d.getDate().toString().padStart(2,'0')}`; }
    function generateInvoiceNumber() { const today = getTodayKey(); let count = parseInt(localStorage.getItem('pos_inv_count') || "0"); const lastDate = localStorage.getItem('pos_last_date'); if (lastDate !== today) { count = 1; } else { count++; } localStorage.setItem('pos_last_date', today); localStorage.setItem('pos_inv_count', count); return today + "-" + count.toString().padStart(3, '0'); }
    function goToStep(s) { document.getElementById('step-1').className = (s===1) ? '' : 'hidden'; document.getElementById('step-2').className = (s===2) ? '' : 'hidden'; document.getElementById('step-3').className = (s===3) ? '' : 'hidden'; if(s===1) { document.getElementById('reprint-only-btn').classList.add('hidden'); document.getElementById('main-submit-btn').classList.remove('hidden'); document.getElementById('main-submit-btn').disabled = true; document.getElementById('wa-btn').classList.remove('hidden'); renderHistory(); } }
    function resetForm() { document.getElementById('s-name').value = ""; document.getElementById('r-name').value = ""; document.getElementById('r-acc').value = ""; document.getElementById('send-amt').value = ""; document.getElementById('recv-amt').value = ""; document.getElementById('submit-msg').style.color = "#e67e22"; goToStep(1); }
    function renderHistory() { document.getElementById('history-body').innerHTML = history.map((item, index) => `<tr><td>${item.invoiceNo}</td><td>${item.ramt}</td><td><button class="btn-reprint" onclick="reprint(${index})">Reprint</button></td></tr>`).join(''); }
    function reprint(idx) { const d = history[idx]; document.getElementById('res-date').innerText = d.date; document.getElementById('res-inv').innerText = d.invoiceNo; document.getElementById('res-branch').innerText = d.branch; document.getElementById('disp-sender').innerText = d.sender; document.getElementById('res-type').innerText = d.resType; document.getElementById('res-rname').innerText = d.receiverName; document.getElementById('res-racc').innerText = d.receiverAcc; document.getElementById('res-samt').innerText = d.resSamt; document.getElementById('res-ramt').innerText = d.ramt; goToStep(3); document.getElementById('main-submit-btn').classList.add('hidden'); document.getElementById('wa-btn').classList.add('hidden'); document.getElementById('reprint-only-btn').classList.remove('hidden'); document.getElementById('submit-msg').innerText = "Historical Reprint Mode"; }
    function clearHistory() { if(confirm("Clear history?")) { localStorage.removeItem('pos_history_v42'); history=[]; renderHistory(); } }
    function validateGo(s) { if (!document.getElementById('s-name').value || !document.getElementById('r-acc').value) return alert("Fill Name/Acc!"); populateReceipt(); goToStep(s); }
    function autoUpdateType() { const c = document.getElementById('recv-cur').value; const t = document.getElementById('recv-type'); if(c==='MYR'){t.value='Malay Bank'}else if(c==='THB'){t.value='Thai Bank'}else{t.value='Bank'} refreshAll(); }

    // --- PWA SERVICE WORKER REGISTRATION ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            const blob = new Blob([`
                self.addEventListener('fetch', function(e) {
                    e.respondWith(fetch(e.request).catch(() => caches.match(e.request)));
                });
            `], { type: 'text/javascript' });
            const url = URL.createObjectURL(blob);
            navigator.serviceWorker.register(url);
        });
    }
    
    window.onload = refreshAll;
</script>
</body>
</html>